import router from '@ohos.router';
import promptAction from '@ohos.promptAction';
import { BusinessError } from '@ohos.base';

// å®šä¹‰ç±»å‹
interface TabItem {
  name: string;
  icon: string;
  page: string;
}

interface ServiceTabItem {
  name: string;
  icon: string;
  tabIndex: number;
}

interface User {
  studentId: string;
  password: string;
}

@Entry
@Component
struct Index {
  @State currentIndex: number = 0;
  @State showRedDot: boolean = true;
  @State isLoggedIn: boolean = false;
  @State studentId: string = '';
  @State password: string = '';

  private tabs: Array<TabItem> = [
    { name: 'æµ‹è¯•', icon: 'ğŸ’¬', page: 'SubPage' },
    { name: 'è¯¾è¡¨', icon: 'ğŸ“…', page: 'SchedulePage' },
    { name: 'åœ°å›¾', icon: 'ğŸ“', page: 'MapPage' },
    { name: 'æœåŠ¡', icon: 'ğŸ“', page: 'Services' }
  ];

  // è½®æ’­å›¾
  private banners: Array<Resource> = [
    $r('app.media.banner1'),
    $r('app.media.banner2'),
    $r('app.media.banner3')
  ];

  // å¿«æ·åŠŸèƒ½
  private serviceTabs: Array<ServiceTabItem> = [
    { name: 'æˆç»©æŸ¥è¯¢', icon: 'ğŸ“Š', tabIndex: 1 },
    { name: 'å›¾ä¹¦æŸ¥è¯¢', icon: 'ğŸ“š', tabIndex: 2 },
    { name: 'é€‰è¯¾æŸ¥è¯¢', icon: 'ğŸ‘¨â€ğŸ“', tabIndex: 3 },
    { name: 'ä¸ªäººä¿¡æ¯', icon: 'ğŸ“', tabIndex: 4 }
  ];

  private copyText: string = 'æ ¡å›­çƒ­çº¿ï¼š400-123-4567';
  private recommendations: Array<string> = ['è®²åº§', 'æ¯”èµ›', 'æ‹›è˜', 'æ´»åŠ¨', 'æ–°é—»'];

  // æ¨¡æ‹Ÿç”¨æˆ·æ•°æ®
  private mockUsers: Array<User> = [
    { studentId: '2224040738', password: '123456' },
    { studentId: '2224040701', password: '123456' },
    { studentId: '2224040702', password: '123456' }
  ];

  // åˆ‡æ¢Tab
  private switchTab(index: number): void {
    try {
      this.currentIndex = index;

      // å¦‚æœç‚¹å‡»çš„æ˜¯è¯¾è¡¨Tabï¼ˆç´¢å¼•ä¸º1ï¼‰ï¼Œæ¸…é™¤çº¢ç‚¹
      if (index === 1) {
        this.showRedDot = false;
      }

      const page = this.tabs[index].page;
      if (page !== 'Index') {
        router.pushUrl({
          url: `pages/${page}`
        } as router.RouterOptions).then(() => {
          console.log('é¡µé¢è·³è½¬æˆåŠŸ');
        }).catch((err: BusinessError) => {
          console.error('é¡µé¢è·³è½¬å¤±è´¥:', err);
        });
      }
    } catch (error) {
      console.error('åˆ‡æ¢Tabé”™è¯¯:', error);
    }
  }

  // ç‚¹å‡»æœåŠ¡å¿«æ·åŠŸèƒ½
  private onServiceTabClick(tabIndex: number): void {
    try {
      const serviceItem = this.serviceTabs.find((item: ServiceTabItem) => item.tabIndex === tabIndex);
      const serviceName = serviceItem?.name || 'æœªçŸ¥åŠŸèƒ½';

      promptAction.showToast({
        message: `åˆ‡æ¢åˆ°${serviceName}`,
        duration: 1500
      });

      router.pushUrl({
        url: 'pages/Services',
        params: { initialTab: tabIndex }
      } as router.RouterOptions).then(() => {
        console.log('è·³è½¬åˆ°æœåŠ¡é¡µé¢æˆåŠŸ');
      }).catch((err: BusinessError) => {
        console.error('è·³è½¬åˆ°æœåŠ¡é¡µé¢å¤±è´¥:', err);
      });
    } catch (error) {
      console.error('æœåŠ¡åŠŸèƒ½ç‚¹å‡»é”™è¯¯:', error);
    }
  }

  // å¤åˆ¶æ–‡æœ¬
  private onCopyText(): void {
    try {
      promptAction.showToast({
        message: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
        duration: 1500
      });
    } catch (error) {
      console.error('å¤åˆ¶é”™è¯¯:', error);
    }
  }

  // æ˜¾ç¤ºæç¤ºä¿¡æ¯
  private showToast(message: string): void {
    try {
      promptAction.showToast({
        message: message,
        duration: 1500
      });
    } catch (error) {
      console.error('æ˜¾ç¤ºæç¤ºä¿¡æ¯é”™è¯¯:', error);
    }
  }

  // å¤„ç†ç™»å½•
  private handleLogin(): void {
    try {
      // éªŒè¯è¾“å…¥
      if (!this.studentId.trim() || !this.password.trim()) {
        this.showToast('è¯·è¾“å…¥å­¦å·å’Œå¯†ç ');
        return;
      }

      // æ¨¡æ‹Ÿç™»å½•éªŒè¯
      const user = this.mockUsers.find(u =>
      u.studentId === this.studentId && u.password === this.password
      );

      if (user) {
        // ç™»å½•æˆåŠŸ
        this.isLoggedIn = true;
        this.showToast('ç™»å½•æˆåŠŸï¼');

        // ä¿å­˜ç™»å½•çŠ¶æ€ï¼ˆå®é™…åº”ç”¨ä¸­åº”è¯¥ä½¿ç”¨æ›´å®‰å…¨çš„å­˜å‚¨æ–¹å¼ï¼‰
        console.log('ç”¨æˆ·ç™»å½•æˆåŠŸ:', this.studentId);
      } else {
        // ç™»å½•å¤±è´¥
        this.showToast('å­¦å·æˆ–å¯†ç é”™è¯¯');
      }
    } catch (error) {
      console.error('ç™»å½•å¤„ç†é”™è¯¯:', error);
      this.showToast('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
    }
  }

  // æ„å»ºç™»å½•é®ç½©å±‚
  @Builder
  buildLoginOverlay() {
    Stack({ alignContent: Alignment.Center }) {
      // åŠé€æ˜èƒŒæ™¯
      Image($r('app.media.login_logo')) // ä½¿ç”¨èµ„æºç®¡ç†å™¨ä¸­çš„å›¾ç‰‡
        .width('100%')
        .height('100%')
        .objectFit(ImageFit.Cover) // è®¾ç½®å›¾ç‰‡å¡«å……æ¨¡å¼
      // ç™»å½•æ¡†
      Column() {
        // æ ‡é¢˜
        Text('æ ¡å›­åŠ©æ‰‹ç™»å½•')
          .fontSize(20)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.Black)
          .margin({ bottom: 30 });

        // å­¦å·è¾“å…¥æ¡†
        Column() {
          Text('å­¦å·')
            .fontSize(14)
            .fontColor(Color.Black)
            .margin({ bottom: 5 });

          TextInput({
            text: this.studentId,
            placeholder: 'è¯·è¾“å…¥å­¦å·'
          })
            .width('100%')
            .height(40)
            .backgroundColor(Color.White)
            .borderRadius(6)
            .padding({ left: 10, right: 10 })
            .type(InputType.Normal)
            .onChange((value: string) => {
              this.studentId = value;
            });
        }
        .margin({ bottom: 20 });

        // å¯†ç è¾“å…¥æ¡†
        Column() {
          Text('å¯†ç ')
            .fontSize(14)
            .fontColor(Color.Black)
            .margin({ bottom: 5 });

          TextInput({
            text: this.password,
            placeholder: 'è¯·è¾“å…¥å¯†ç '
          })
            .width('100%')
            .height(40)
            .backgroundColor(Color.White)
            .borderRadius(6)
            .padding({ left: 10, right: 10 })
            .type(InputType.Password)
            .onChange((value: string) => {
              this.password = value;
            });
        }
        .margin({ bottom: 30 });

        // ç™»å½•æŒ‰é’®
        Button('ç™»å½•', { type: ButtonType.Capsule })
          .width('80%')
          .height(40)
          .backgroundColor(Color.Blue)
          .fontColor(Color.White)
          .fontSize(16)
          .onClick(() => {
            this.handleLogin();
          });

        // æç¤ºä¿¡æ¯
        Text('æµ‹è¯•è´¦å·ï¼š2224040738 å¯†ç ï¼š123456')
          .fontSize(12)
          .fontColor(Color.Gray)
          .margin({ top: 20 });
      }
      .width('80%')
      .padding(30)
      .backgroundColor('rgba(255, 255, 255, 0.85)')
      .borderRadius(15)
      .justifyContent(FlexAlign.Center)
    }
    .width('100%')
    .height('100%')
    .position({ x: 0, y: 0 })
    .zIndex(999)
  }

  // æ„å»ºä¸»é¡µé¢å†…å®¹
  @Builder
  buildMainContent() {
    Column() {
      Stack() {
        Column() {
          // 1. è½®æ’­å›¾
          Swiper() {
            ForEach(this.banners, (item: Resource, index: number) => {
              Image(item)
                .width('100%')
                .height(120)
                .objectFit(ImageFit.Cover)
            }, (item: Resource, index: number) => `banner-${index}`)
          }
          .width('100%')
          .height(120)
          .indicator(true)
          .loop(true)
          .margin({ top: 10 });

          // 2. æ¨ªå‘æ»šåŠ¨åŒº
          Column() {
            Text('çƒ­é—¨æ¨è')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 10, bottom: 8, left: 12 });

            Scroll() {
              Row() {
                ForEach(this.recommendations, (item: string) => {
                  Column() {
                    Text(item)
                      .fontSize(14)
                      .fontColor(Color.White);
                  }
                  .width(100)
                  .height(60)
                  .backgroundColor(Color.Blue)
                  .borderRadius(6)
                  .margin({ right: 8 })
                  .justifyContent(FlexAlign.Center);
                }, (item: string) => item)
              }
              .padding({ left: 12, right: 12 });
            }
            .scrollable(ScrollDirection.Horizontal)
            .height(70);
          }

          // 3. å¿«æ·åŠŸèƒ½å…¥å£
          Column() {
            Text('å¿«æ·åŠŸèƒ½')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 10, bottom: 8, left: 12 });

            Scroll() {
              Row() {
                ForEach(this.serviceTabs, (item: ServiceTabItem) => {
                  Column() {
                    Stack() {
                      Circle({ width: 40, height: 40 })
                        .fill(Color.Blue);
                      Text(item.icon)
                        .fontSize(16);
                    }
                    .margin({ bottom: 4 });

                    Text(item.name)
                      .fontSize(12)
                      .margin({ top: 2 });
                  }
                  .onClick(() => {
                    this.onServiceTabClick(item.tabIndex);
                  })
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .width(80)
                  .height(90)
                  .margin({ right: 15 })
                }, (item: ServiceTabItem) => `${item.name}-${item.tabIndex}`)
              }
              .padding({ left: 12, right: 12 })
            }
            .scrollable(ScrollDirection.Horizontal)
            .height(100)
            .margin({ bottom: 10 })
          }

          // 4. æ ¡å›­å…¬å‘Š
          Column() {
            Text('æ ¡å›­å…¬å‘Š')
              .fontSize(18)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 10, bottom: 10, left: 12 });

            Column() {
              Text('é‡è¦é€šçŸ¥')
                .fontSize(16)
                .fontColor(Color.Red)
                .fontWeight(FontWeight.Bold)
                .margin({ bottom: 6 });
              Text('ç³»ç»Ÿç»´æŠ¤é€šçŸ¥')
                .fontSize(14)
                .margin({ top: 4 });
              Text('æ—¶é—´ï¼šå‘¨æœ«00:00-06:00')
                .fontSize(12)
                .fontColor(Color.Gray)
                .margin({ top: 6, bottom: 4 });
              Text('ç»´æŠ¤èŒƒå›´ï¼šæˆç»©æŸ¥è¯¢ã€é€‰è¯¾ç³»ç»Ÿã€å›¾ä¹¦å€Ÿé˜…ç³»ç»Ÿ')
                .fontSize(12)
                .fontColor(Color.Gray)
                .margin({ top: 6 });
            }
            .padding(20)
            .backgroundColor(0xF5F5F5)
            .borderRadius(8)
            .margin({ left: 12, right: 12 })
            .width('95%')
            .height(180)
          }

          // 5. æ–‡å­—å¤åˆ¶åŠŸèƒ½
          Column() {
            Text('è”ç³»æ–¹å¼')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 10, bottom: 8, left: 12 });

            Text(this.copyText)
              .fontSize(12)
              .padding(12)
              .backgroundColor(0xF5F5F5)
              .borderRadius(8)
              .margin({ left: 12, right: 12 })
              .onClick(() => {
                this.onCopyText();
              });
          }
          .margin({ bottom: 12 });
        }
        .width('100%')
      }
      .flexGrow(1)

      // åº•éƒ¨TabBar
      Row() {
        ForEach(this.tabs, (tab: TabItem, index: number) => {
          Column() {
            if (tab.name === 'è¯¾è¡¨' && this.showRedDot) {
              Circle({ width: 6, height: 6 })
                .fill(Color.Red)
                .position({ x: 20, y: 0 });
            }

            Text(tab.icon)
              .fontSize(18);

            Text(tab.name)
              .fontSize(10)
              .fontColor(this.currentIndex === index ? Color.Blue : Color.Gray)
              .margin({ top: 2 });
          }
          .width('25%')
          .height(50)
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            this.switchTab(index);
          });
        }, (tab: TabItem) => tab.name)
      }
      .width('100%')
      .height(50)
      .backgroundColor(Color.White)
      .border({ width: 1, color: 0xE0E0E0 });
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White);
  }

  build() {
    Stack() {
      // ä¸»é¡µé¢å†…å®¹
      this.buildMainContent();

      // å¦‚æœæœªç™»å½•ï¼Œæ˜¾ç¤ºç™»å½•é®ç½©
      if (!this.isLoggedIn) {
        this.buildLoginOverlay();
      }
    }
    .width('100%')
    .height('100%');
  }
}