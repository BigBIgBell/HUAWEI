import router from '@ohos.router';
import promptAction from '@ohos.promptAction';

// å®šä¹‰ç±»åž‹
interface TabItem {
  name: string;
  icon: string;
  page: string;
}

interface ServiceTabItem {
  name: string;
  icon: string;
  tabIndex: number;
}

@Entry
@Component
struct Index {
  @State currentIndex: number = 0;
  @State showRedDot: boolean = true;

  // åº•éƒ¨å¯¼èˆªTabs - å°†å¯¼èˆªæ”¹ä¸ºè¯¾è¡¨
  private tabs: TabItem[] = [
    { name: 'é¦–é¡µ', icon: 'ðŸ ', page: 'Index' },
    { name: 'è¯¾è¡¨', icon: 'ðŸ“…', page: 'SchedulePage' },
    { name: 'åœ°å›¾', icon: 'ðŸ“', page: 'MapPage' },
    { name: 'æœåŠ¡', icon: 'ðŸŽ“', page: 'Services' }
  ];

  // è½®æ’­å›¾ - æ”¹ä¸ºå›¾ç‰‡èµ„æº
  private banners: Resource[] = [
    $r('app.media.banner1'), // ç¬¬ä¸€å¼ è½®æ’­å›¾
    $r('app.media.banner2'), // ç¬¬äºŒå¼ è½®æ’­å›¾
    $r('app.media.banner3')  // ç¬¬ä¸‰å¼ è½®æ’­å›¾
  ];

  // å¿«æ·åŠŸèƒ½
  private serviceTabs: ServiceTabItem[] = [
    { name: 'æˆç»©æŸ¥è¯¢', icon: 'ðŸ“Š', tabIndex: 1 },
    { name: 'å›¾ä¹¦æŸ¥è¯¢', icon: 'ðŸ“š', tabIndex: 2 },
    { name: 'é€‰è¯¾æŸ¥è¯¢', icon: 'ðŸ‘¨â€ðŸŽ“', tabIndex: 3 },
    { name: 'ä¸ªäººä¿¡æ¯', icon: 'ðŸ“', tabIndex: 4 }
  ];

  private copyText: string = 'æ ¡å›­çƒ­çº¿ï¼š400-123-4567';
  private recommendations: string[] = ['è®²åº§', 'æ¯”èµ›', 'æ‹›è˜', 'æ´»åŠ¨', 'æ–°é—»'];

  // åˆ‡æ¢Tab
  private switchTab(index: number): void {
    try {
      this.currentIndex = index;
      const page = this.tabs[index].page;
      if (page !== 'Index') {
        router.pushUrl({ url: `pages/${page}` });
      }
    } catch (error) {
      console.error('åˆ‡æ¢Tabé”™è¯¯:', error);
    }
  }

  // ç‚¹å‡»æœåŠ¡å¿«æ·åŠŸèƒ½
  private onServiceTabClick(tabIndex: number): void {
    try {
      const serviceName = this.serviceTabs[tabIndex - 1].name;
      promptAction.showToast({
        message: `åˆ‡æ¢åˆ°${serviceName}`,
        duration: 1500
      });

      router.pushUrl({
        url: 'pages/Services',
        params: { initialTab: tabIndex }
      });
    } catch (error) {
      console.error('æœåŠ¡åŠŸèƒ½ç‚¹å‡»é”™è¯¯:', error);
    }
  }

  // å¤åˆ¶æ–‡æœ¬
  private onCopyText(): void {
    try {
      promptAction.showToast({
        message: 'å·²å¤åˆ¶åˆ°å‰ªè´´æ¿',
        duration: 1500
      });
    } catch (error) {
      console.error('å¤åˆ¶é”™è¯¯:', error);
    }
  }

  build() {
    Column() {
      // é¡µé¢å†…å®¹ - ä½¿ç”¨Stackç¡®ä¿å†…å®¹é€‚åº”å±å¹•
      Stack() {
        Column() {
          // 1. è½®æ’­å›¾ - æ”¹ä¸ºImageç»„ä»¶
          Swiper() {
            ForEach(this.banners, (item: Resource, index: number) => {
              Image(item)
                .width('100%')
                .height(120)
                .objectFit(ImageFit.Cover)
            }, (item: Resource, index: number) => `banner-${index}`)
          }
          .width('100%')
          .height(120)
          .indicator(true)
          .loop(true)
          .margin({ top: 10 });

          // 2. æ¨ªå‘æ»šåŠ¨åŒº
          Column() {
            Text('çƒ­é—¨æŽ¨è')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 10, bottom: 8, left: 12 });

            Scroll() {
              Row() {
                ForEach(this.recommendations, (item: string) => {
                  Column() {
                    Text(item)
                      .fontSize(14)
                      .fontColor(Color.White);
                  }
                  .width(100)
                  .height(60)
                  .backgroundColor(Color.Blue)
                  .borderRadius(6)
                  .margin({ right: 8 })
                  .justifyContent(FlexAlign.Center);
                }, (item: string) => item)
              }
              .padding({ left: 12, right: 12 });
            }
            .scrollable(ScrollDirection.Horizontal)
            .height(70);
          }

          // 3. å¿«æ·åŠŸèƒ½å…¥å£
          Column() {
            Text('å¿«æ·åŠŸèƒ½')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 10, bottom: 8, left: 12 });

            Grid() {
              ForEach(this.serviceTabs, (item: ServiceTabItem) => {
                GridItem() {
                  Column() {
                    // å›¾æ ‡
                    Stack() {
                      Circle({ width: 40, height: 40 })
                        .fill(Color.Blue);
                      Text(item.icon)
                        .fontSize(16);
                    }
                    .margin({ bottom: 4 });

                    Text(item.name)
                      .fontSize(12)
                      .margin({ top: 2 });
                  }
                  .onClick(() => {
                    this.onServiceTabClick(item.tabIndex);
                  })
                  .justifyContent(FlexAlign.Center)
                  .alignItems(HorizontalAlign.Center)
                  .height(90);
                }
              }, (item: ServiceTabItem) => `${item.name}-${item.tabIndex}`)
            }
            .columnsTemplate('1fr 1fr')
            .rowsTemplate('1fr 1fr')
            .columnsGap(10)
            .rowsGap(10)
            .height(200)
            .margin({ bottom: 10, left: 12, right: 12 });
          }

          // 4. å¯Œæ–‡æœ¬å±•ç¤ºåŒº
          Column() {
            Text('æ ¡å›­å…¬å‘Š')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ bottom: 8, left: 12 });

            Column() {
              Text('é‡è¦é€šçŸ¥')
                .fontSize(14)
                .fontColor(Color.Red)
                .fontWeight(FontWeight.Bold);
              Text('ç³»ç»Ÿç»´æŠ¤é€šçŸ¥')
                .fontSize(12)
                .margin({ top: 4 });
              Text('æ—¶é—´ï¼šå‘¨æœ«00:00-06:00')
                .fontSize(10)
                .fontColor(Color.Gray)
                .margin({ top: 4 });
            }
            .padding(12)
            .backgroundColor(0xF5F5F5)
            .borderRadius(8)
            .margin({ left: 12, right: 12 });
          }

          // 5. æ–‡å­—å¤åˆ¶åŠŸèƒ½
          Column() {
            Text('è”ç³»æ–¹å¼')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .margin({ top: 10, bottom: 8, left: 12 });

            Text(this.copyText)
              .fontSize(12)
              .padding(12)
              .backgroundColor(0xF5F5F5)
              .borderRadius(8)
              .margin({ left: 12, right: 12 })
              .onClick(() => {
                this.onCopyText();
              });
          }
          .margin({ bottom: 12 });
        }
        .width('100%')
      }
      .flexGrow(1)

      // åº•éƒ¨TabBar
      Row() {
        ForEach(this.tabs, (tab: TabItem, index: number) => {
          Column() {
            // çº¢ç‚¹æ ‡è®°
            if (tab.name === 'è¯¾è¡¨' && this.showRedDot) {
              Circle({ width: 6, height: 6 })
                .fill(Color.Red)
                .position({ x: 20, y: 0 });
            }

            Text(tab.icon)
              .fontSize(18);

            Text(tab.name)
              .fontSize(10)
              .fontColor(this.currentIndex === index ? Color.Blue : Color.Gray)
              .margin({ top: 2 });
          }
          .width('25%')
          .height(50)
          .justifyContent(FlexAlign.Center)
          .onClick(() => {
            this.switchTab(index);
          });
        }, (tab: TabItem) => tab.name)
      }
      .width('100%')
      .height(50)
      .backgroundColor(Color.White)
      .border({ width: 1, color: 0xE0E0E0 });
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.White);
  }
}