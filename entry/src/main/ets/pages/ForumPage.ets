import router from '@ohos.router';

// å®šä¹‰ç”¨æˆ·ç±»å‹
interface User {
  id: string;
  name: string;
  avatar: string;
}

// å®šä¹‰å¸–å­ç±»å‹
interface Post {
  id: string;
  userId: string;
  userName: string;
  avatar: string;
  content: string;
  time: string;
  likes: number;
  comments: number;
  shares: number;
  type: 'text' | 'image' | 'video' | 'file';
}

@Entry
@Component
struct ForumPage {
  // å½“å‰ç”¨æˆ·
  private currentUser: User = { id: 'user1', name: 'å°æ˜', avatar: 'ğŸ˜Š' };

  @State posts: Post[] = [
    {
      id: 'post1',
      userId: 'user1',
      userName: 'å°æ˜',
      avatar: 'ğŸ˜Š',
      content: 'ä»Šå¤©å­¦æ ¡çš„æ¨±èŠ±å¼€äº†ï¼Œå¤ªç¾äº†ï¼å¤§å®¶ä¸€èµ·å»çœ‹æ¨±èŠ±å§ï¼',
      time: '2å°æ—¶å‰',
      likes: 45,
      comments: 12,
      shares: 3,
      type: 'text'
    },
    {
      id: 'post2',
      userId: 'user2',
      userName: 'å°çº¢',
      avatar: 'ğŸ‘©',
      content: 'åˆšåˆšå‚åŠ äº†å­¦æ ¡çš„ç¼–ç¨‹æ¯”èµ›ï¼Œè·å¾—äº†ç¬¬ä¸€åï¼å¤ªå¼€å¿ƒäº†ï¼',
      time: '4å°æ—¶å‰',
      likes: 128,
      comments: 56,
      shares: 8,
      type: 'text'
    },
    {
      id: 'post3',
      userId: 'user3',
      userName: 'å°åˆš',
      avatar: 'ğŸ‘¨',
      content: 'ä»Šå¤©æ‹äº†ä¸€å¼ æ¼‚äº®çš„é£æ™¯ç…§ï¼Œåˆ†äº«ç»™å¤§å®¶ï¼',
      time: '6å°æ—¶å‰',
      likes: 89,
      comments: 24,
      shares: 5,
      type: 'image'
    },
    {
      id: 'post4',
      userId: 'user4',
      userName: 'å°èŠ±',
      avatar: 'ğŸŒ¸',
      content: 'ä¸Šä¼ äº†ä¸€ä»½å­¦ä¹ èµ„æ–™ï¼Œéœ€è¦çš„åŒå­¦å¯ä»¥ä¸‹è½½ï¼',
      time: '8å°æ—¶å‰',
      likes: 156,
      comments: 42,
      shares: 12,
      type: 'file'
    }
  ];

  @State newPostContent: string = '';
  @State isTakingPhoto: boolean = false;
  @State isSelectingFile: boolean = false;

  build() {
    Column() {
      // æ ‡é¢˜æ  - æ·»åŠ è¿”å›æŒ‰é’®
      Row() {
        // è¿”å›æŒ‰é’®
        Button('â†')
          .width(40)
          .height(40)
          .fontSize(20)
          .fontColor(Color.White)
          .backgroundColor(Color.Transparent)
          .onClick(() => {
            this.goBackToHome();
          })
          .margin({ left: 10 })

        Text('æ ¡å›­è®ºå›')
          .fontSize(24)
          .fontWeight(FontWeight.Bold)
          .fontColor(Color.White)
          .margin({ left: 10 })
          .flexGrow(1)
      }
      .width('100%')
      .height(60)
      .backgroundColor('#409EFF')
      .alignItems(VerticalAlign.Center)

      // å‘å¸ƒæ–°å¸–å­åŒºåŸŸ
      Column() {
        Row() {
          // ç”¨æˆ·å¤´åƒ
          Text(this.currentUser.avatar)
            .fontSize(30)
            .margin({ left: 15, right: 10 })

          // å‘å¸ƒè¾“å…¥æ¡†
          Column() {
            TextInput({ placeholder: 'åˆ†äº«ä½ çš„æƒ³æ³•...' })
              .width('100%')
              .height(60)
              .fontSize(16)
              .onChange((value: string) => {
                this.newPostContent = value;
              })

            Row() {
              // æ‹ç…§æŒ‰é’®
              Button('ğŸ“¸ æ‹ç…§')
                .height(36)
                .fontSize(14)
                .backgroundColor('#ECF5FF')
                .fontColor('#409EFF')
                .margin({ right: 10 })
                .onClick(() => {
                  this.takePhoto();
                })

              // æ–‡ä»¶é€‰æ‹©æŒ‰é’®
              Button('ğŸ“ æ–‡ä»¶')
                .height(36)
                .fontSize(14)
                .backgroundColor('#F0F9EB')
                .fontColor('#67C23A')
                .margin({ right: 10 })
                .onClick(() => {
                  this.selectFile();
                })

              Button('å‘å¸ƒ')
                .height(36)
                .fontSize(14)
                .backgroundColor('#409EFF')
                .fontColor(Color.White)
                .onClick(() => {
                  this.publishPost();
                })
            }
            .margin({ top: 10 })
          }
          .layoutWeight(1)
          .margin({ right: 15 })
        }
        .padding({ top: 15, bottom: 15 })
        .backgroundColor(Color.White)
      }
      .width('100%')
      .shadow({ radius: 2, color: 0x10000000 })

      // æ‹ç…§å’Œæ–‡ä»¶é€‰æ‹©çŠ¶æ€æç¤º
      if (this.isTakingPhoto) {
        Column() {
          Text('ğŸ“¸ æ­£åœ¨æ‰“å¼€ç›¸æœº...')
            .fontSize(16)
            .fontColor('#409EFF')
            .margin({ top: 10, bottom: 5 })
          Text('è¯·å…è®¸ç›¸æœºæƒé™ï¼Œå¯¹å‡†æ‹æ‘„ç›®æ ‡')
            .fontSize(14)
            .fontColor('#909399')
          Text('å¤„ç†ä¸­...')
            .fontSize(16)
            .fontColor('#409EFF')
            .margin({ top: 10 })
        }
        .padding(15)
        .backgroundColor('#F0F9FF')
        .borderRadius(8)
        .margin({ top: 10, left: 15, right: 15 })
      }

      if (this.isSelectingFile) {
        Column() {
          Text('ğŸ“‚ æ­£åœ¨æ‰“å¼€æ–‡ä»¶ç®¡ç†å™¨...')
            .fontSize(16)
            .fontColor('#67C23A')
            .margin({ top: 10, bottom: 5 })
          Text('è¯·é€‰æ‹©è¦ä¸Šä¼ çš„æ–‡ä»¶')
            .fontSize(14)
            .fontColor('#909399')
          Text('å¤„ç†ä¸­...')
            .fontSize(16)
            .fontColor('#67C23A')
            .margin({ top: 10 })
        }
        .padding(15)
        .backgroundColor('#F0F9EB')
        .borderRadius(8)
        .margin({ top: 10, left: 15, right: 15 })
      }

      // å¸–å­åˆ—è¡¨
      Scroll() {
        Column() {
          // é¡¶éƒ¨ç»Ÿè®¡ä¿¡æ¯
          Row() {
            Column() {
              Text('ä»Šæ—¥å¸–å­')
                .fontSize(12)
                .fontColor('#909399')
              Text('4')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#409EFF')
            }
            .padding(10)
            .backgroundColor('#F5F7FA')
            .borderRadius(8)
            .margin({ right: 10 })

            Column() {
              Text('æ´»è·ƒç”¨æˆ·')
                .fontSize(12)
                .fontColor('#909399')
              Text('128')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#67C23A')
            }
            .padding(10)
            .backgroundColor('#F5F7FA')
            .borderRadius(8)
            .margin({ right: 10 })

            Column() {
              Text('æ€»å¸–å­æ•°')
                .fontSize(12)
                .fontColor('#909399')
              Text('1,234')
                .fontSize(20)
                .fontWeight(FontWeight.Bold)
                .fontColor('#E6A23C')
            }
            .padding(10)
            .backgroundColor('#F5F7FA')
            .borderRadius(8)
          }
          .padding({ left: 15, right: 15, top: 15, bottom: 10 })
          .justifyContent(FlexAlign.SpaceBetween)

          // å¸–å­åˆ—è¡¨
          ForEach(this.posts, (post: Post) => {
            Column() {
              // ç”¨æˆ·ä¿¡æ¯è¡Œ
              Row() {
                // ç”¨æˆ·å¤´åƒ
                Column() {
                  Text(post.avatar)
                    .fontSize(28)
                }
                .width(50)
                .height(50)
                .backgroundColor('#ECF5FF')
                .borderRadius(25)
                .justifyContent(FlexAlign.Center)

                // ç”¨æˆ·åå’Œæ—¶é—´
                Column() {
                  Text(post.userName)
                    .fontSize(16)
                    .fontWeight(FontWeight.Medium)
                  Text(post.time)
                    .fontSize(12)
                    .fontColor('#909399')
                }
                .margin({ left: 10 })
                .layoutWeight(1)
              }
              .padding({ left: 15, right: 15, top: 15 })

              // å¸–å­å†…å®¹
              Text(post.content)
                .fontSize(15)
                .lineHeight(22)
                .padding({ left: 15, right: 15, top: 10, bottom: 10 })

              // æ ¹æ®ç±»å‹æ˜¾ç¤ºä¸åŒçš„å†…å®¹
              if (post.type === 'image') {
                Column() {
                  Row() {
                    Text('ğŸ“¸')
                      .fontSize(16)
                      .margin({ right: 8 })
                    Text('ç…§ç‰‡ï¼šé£æ™¯ç…§.jpg')
                      .fontSize(14)
                      .fontColor('#409EFF')
                  }
                  .padding(10)
                  .width('90%')
                  .backgroundColor('#F0F9FF')
                  .borderRadius(8)
                }
                .margin({ left: 15, right: 15, bottom: 10 })
              } else if (post.type === 'file') {
                Column() {
                  Row() {
                    Text('ğŸ“')
                      .fontSize(16)
                      .margin({ right: 8 })
                    Column() {
                      Text('å­¦ä¹ èµ„æ–™.pdf')
                        .fontSize(14)
                        .fontColor('#67C23A')
                      Text('2.5 MB â€¢ ç‚¹å‡»ä¸‹è½½')
                        .fontSize(12)
                        .fontColor('#909399')
                    }
                  }
                  .padding(10)
                  .width('90%')
                  .backgroundColor('#F0F9EB')
                  .borderRadius(8)
                }
                .margin({ left: 15, right: 15, bottom: 10 })
              }

              // äº’åŠ¨æŒ‰é’®è¡Œ
              Row() {
                // ç‚¹èµæŒ‰é’®
                Button() {
                  Row() {
                    Text('ğŸ‘')
                      .fontSize(16)
                      .margin({ right: 5 })
                    Text(post.likes.toString())
                      .fontSize(14)
                  }
                }
                .height(36)
                .backgroundColor(Color.Transparent)
                .borderColor('#DCDFE6')
                .borderWidth(1)
                .onClick(() => {
                  this.likePost(post.id);
                })

                // è¯„è®ºæŒ‰é’®
                Button() {
                  Row() {
                    Text('ğŸ’¬')
                      .fontSize(16)
                      .margin({ right: 5 })
                    Text(post.comments.toString())
                      .fontSize(14)
                  }
                }
                .height(36)
                .backgroundColor(Color.Transparent)
                .borderColor('#DCDFE6')
                .borderWidth(1)
                .margin({ left: 10 })
                .onClick(() => {
                  this.commentPost(post.id);
                })

                // åˆ†äº«æŒ‰é’®
                Button() {
                  Row() {
                    Text('â†ªï¸')
                      .fontSize(16)
                      .margin({ right: 5 })
                    Text(post.shares.toString())
                      .fontSize(14)
                  }
                }
                .height(36)
                .backgroundColor(Color.Transparent)
                .borderColor('#DCDFE6')
                .borderWidth(1)
                .margin({ left: 10 })
                .onClick(() => {
                  this.sharePost(post.id);
                })
              }
              .padding({ left: 15, right: 15, bottom: 15 })
            }
            .backgroundColor(Color.White)
            .borderRadius(12)
            .margin({ top: 10, left: 10, right: 10, bottom: 10 })
            .shadow({ radius: 4, color: 0x08000000 })
          }, (post: Post) => post.id)
        }
        .padding({ bottom: 20 })
      }
      .layoutWeight(1)
      .backgroundColor('#F0F2F5')
    }
    .width('100%')
    .height('100%')
  }

  // è¿”å›ä¸»é¡µ
  private goBackToHome(): void {
    console.log('è¿”å›ä¸»é¡µ');
    // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥ä½¿ç”¨ router è¿”å›ä¸Šä¸€ä¸ªé¡µé¢æˆ–è·³è½¬åˆ°ä¸»é¡µ
  }

  // æ‹ç…§åŠŸèƒ½
  private takePhoto(): void {
    console.log('è°ƒç”¨ç³»ç»Ÿç›¸æœºæ‹ç…§');
    this.isTakingPhoto = true;

    // æ¨¡æ‹Ÿæ‹ç…§è¿‡ç¨‹
    setTimeout(() => {
      this.isTakingPhoto = false;
      console.log('æ‹ç…§å®Œæˆï¼Œç…§ç‰‡å·²ä¿å­˜');

      // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å¤„ç†ç›¸æœºè¿”å›çš„ç…§ç‰‡
      // ä¾‹å¦‚ï¼šå°†ç…§ç‰‡æ·»åŠ åˆ°å¸–å­å†…å®¹ä¸­

      // è¿™é‡Œæˆ‘ä»¬åªæ˜¯æ¨¡æ‹Ÿæ·»åŠ ä¸€æ¡åŒ…å«ç…§ç‰‡çš„å¸–å­
      const photoPost: Post = {
        id: 'photo_' + new Date().getTime(),
        userId: this.currentUser.id,
        userName: this.currentUser.name,
        avatar: this.currentUser.avatar,
        content: 'åˆšåˆšæ‹äº†ä¸€å¼ ç…§ç‰‡ï¼',
        time: 'åˆšåˆš',
        likes: 0,
        comments: 0,
        shares: 0,
        type: 'image'
      };

      const updatedPosts: Post[] = [];
      updatedPosts.push(photoPost);
      for (let i = 0; i < this.posts.length; i++) {
        updatedPosts.push(this.posts[i]);
      }
      this.posts = updatedPosts;

    }, 2000);
  }

  // é€‰æ‹©æ–‡ä»¶åŠŸèƒ½
  private selectFile(): void {
    console.log('è°ƒç”¨ç³»ç»Ÿæ–‡ä»¶ç®¡ç†å™¨');
    this.isSelectingFile = true;

    // æ¨¡æ‹Ÿæ–‡ä»¶é€‰æ‹©è¿‡ç¨‹
    setTimeout(() => {
      this.isSelectingFile = false;
      console.log('æ–‡ä»¶é€‰æ‹©å®Œæˆ');

      // åœ¨å®é™…åº”ç”¨ä¸­ï¼Œè¿™é‡Œåº”è¯¥å¤„ç†æ–‡ä»¶é€‰æ‹©å™¨è¿”å›çš„æ–‡ä»¶
      // ä¾‹å¦‚ï¼šå°†æ–‡ä»¶ä¿¡æ¯æ·»åŠ åˆ°å¸–å­å†…å®¹ä¸­

      // è¿™é‡Œæˆ‘ä»¬åªæ˜¯æ¨¡æ‹Ÿæ·»åŠ ä¸€æ¡åŒ…å«æ–‡ä»¶çš„å¸–å­
      const filePost: Post = {
        id: 'file_' + new Date().getTime(),
        userId: this.currentUser.id,
        userName: this.currentUser.name,
        avatar: this.currentUser.avatar,
        content: 'ä¸Šä¼ äº†ä¸€ä¸ªæ–‡ä»¶ï¼',
        time: 'åˆšåˆš',
        likes: 0,
        comments: 0,
        shares: 0,
        type: 'file'
      };

      const updatedPosts: Post[] = [];
      updatedPosts.push(filePost);
      for (let i = 0; i < this.posts.length; i++) {
        updatedPosts.push(this.posts[i]);
      }
      this.posts = updatedPosts;

    }, 1500);
  }

  // å‘å¸ƒæ–°å¸–å­
  private publishPost(): void {
    if (!this.newPostContent.trim()) {
      console.log('è¯·è¾“å…¥å†…å®¹');
      return;
    }

    // åˆ›å»ºæ–°å¸–å­
    const newPost: Post = {
      id: 'post_' + new Date().getTime(),
      userId: this.currentUser.id,
      userName: this.currentUser.name,
      avatar: this.currentUser.avatar,
      content: this.newPostContent,
      time: 'åˆšåˆš',
      likes: 0,
      comments: 0,
      shares: 0,
      type: 'text'
    };

    // æ›´æ–°å¸–å­åˆ—è¡¨
    const updatedPosts: Post[] = [];
    updatedPosts.push(newPost);

    for (let i = 0; i < this.posts.length; i++) {
      updatedPosts.push(this.posts[i]);
    }

    this.posts = updatedPosts;
    this.newPostContent = '';

    console.log('å‘å¸ƒæˆåŠŸ');
  }

  // ç‚¹èµå¸–å­
  private likePost(postId: string): void {
    const updatedPosts: Post[] = [];

    for (let i = 0; i < this.posts.length; i++) {
      const post = this.posts[i];
      if (post.id === postId) {
        // åˆ›å»ºæ–°å¯¹è±¡
        const updatedPost: Post = {
          id: post.id,
          userId: post.userId,
          userName: post.userName,
          avatar: post.avatar,
          content: post.content,
          time: post.time,
          likes: post.likes + 1,
          comments: post.comments,
          shares: post.shares,
          type: post.type
        };
        updatedPosts.push(updatedPost);
      } else {
        updatedPosts.push(post);
      }
    }

    this.posts = updatedPosts;
    console.log('ç‚¹èµå¸–å­:', postId);
  }

  // è¯„è®ºå¸–å­
  private commentPost(postId: string): void {
    const updatedPosts: Post[] = [];

    for (let i = 0; i < this.posts.length; i++) {
      const post = this.posts[i];
      if (post.id === postId) {
        const updatedPost: Post = {
          id: post.id,
          userId: post.userId,
          userName: post.userName,
          avatar: post.avatar,
          content: post.content,
          time: post.time,
          likes: post.likes,
          comments: post.comments + 1,
          shares: post.shares,
          type: post.type
        };
        updatedPosts.push(updatedPost);
      } else {
        updatedPosts.push(post);
      }
    }

    this.posts = updatedPosts;
    console.log('è¯„è®ºå¸–å­:', postId);
  }

  // åˆ†äº«å¸–å­
  private sharePost(postId: string): void {
    const updatedPosts: Post[] = [];

    for (let i = 0; i < this.posts.length; i++) {
      const post = this.posts[i];
      if (post.id === postId) {
        const updatedPost: Post = {
          id: post.id,
          userId: post.userId,
          userName: post.userName,
          avatar: post.avatar,
          content: post.content,
          time: post.time,
          likes: post.likes,
          comments: post.comments,
          shares: post.shares + 1,
          type: post.type
        };
        updatedPosts.push(updatedPost);
      } else {
        updatedPosts.push(post);
      }
    }

    this.posts = updatedPosts;
    console.log('åˆ†äº«å¸–å­:', postId);
  }
}